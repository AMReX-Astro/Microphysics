
INTEGRATOR_DIR ?= VODE

# Arbitrarily number the integrators so we can preprocessor tests in the code.

INTEGRATOR_NUM := -1

ifeq ($(INTEGRATOR_DIR),VODE)
  INTEGRATOR_NUM := 0
else ifeq ($(INTEGRATOR_DIR),BS)
  INTEGRATOR_NUM := 1
else ifeq ($(INTEGRATOR_DIR),VBDF)
  INTEGRATOR_NUM := 2
else ifeq ($(INTEGRATOR_DIR),VODE90)
  # VODE90 is a drop-in replacement for VODE, treat it the same way.
  INTEGRATOR_NUM := 0
endif

DEFINES += -DINTEGRATOR=$(INTEGRATOR_NUM)

# Include all integrators in the build.

ifeq ($(INTEGRATOR_DIR),VODE)

  # Include VODE and BS

  INCLUDE_LOCATIONS += $(MICROPHYSICS_HOME)/integration/VODE
  VPATH_LOCATIONS   += $(MICROPHYSICS_HOME)/integration/VODE
  EXTERN_CORE       += $(MICROPHYSICS_HOME)/integration/VODE

  include $(MICROPHYSICS_HOME)/integration/VODE/Make.package

  INCLUDE_LOCATIONS += $(MICROPHYSICS_HOME)/integration/BS
  VPATH_LOCATIONS   += $(MICROPHYSICS_HOME)/integration/BS
  EXTERN_CORE       += $(MICROPHYSICS_HOME)/integration/BS

  include $(MICROPHYSICS_HOME)/integration/BS/Make.package

else ifeq ($(INTEGRATOR_DIR),VODE90)

  # Include VODE90 and BS

  INCLUDE_LOCATIONS += $(MICROPHYSICS_HOME)/integration/VODE90
  VPATH_LOCATIONS   += $(MICROPHYSICS_HOME)/integration/VODE90
  EXTERN_CORE       += $(MICROPHYSICS_HOME)/integration/VODE90

  include $(MICROPHYSICS_HOME)/integration/VODE90/Make.package

  INCLUDE_LOCATIONS += $(MICROPHYSICS_HOME)/integration/BS
  VPATH_LOCATIONS   += $(MICROPHYSICS_HOME)/integration/BS
  EXTERN_CORE       += $(MICROPHYSICS_HOME)/integration/BS

  include $(MICROPHYSICS_HOME)/integration/BS/Make.package

else ifeq ($(INTEGRATOR_DIR),BS)

  # Include BS and VODE90

  INCLUDE_LOCATIONS += $(MICROPHYSICS_HOME)/integration/VODE90
  VPATH_LOCATIONS   += $(MICROPHYSICS_HOME)/integration/VODE90
  EXTERN_CORE       += $(MICROPHYSICS_HOME)/integration/VODE90

  include $(MICROPHYSICS_HOME)/integration/VODE90/Make.package

  INCLUDE_LOCATIONS += $(MICROPHYSICS_HOME)/integration/BS
  VPATH_LOCATIONS   += $(MICROPHYSICS_HOME)/integration/BS
  EXTERN_CORE       += $(MICROPHYSICS_HOME)/integration/BS

  include $(MICROPHYSICS_HOME)/integration/BS/Make.package

else

  INCLUDE_LOCATIONS += $(MICROPHYSICS_HOME)/integration/$(INTEGRATOR_DIR)
  VPATH_LOCATIONS   += $(MICROPHYSICS_HOME)/integration/$(INTEGRATOR_DIR)
  EXTERN_CORE       += $(MICROPHYSICS_HOME)/integration/$(INTEGRATOR_DIR)

  include $(MICROPHYSICS_HOME)/integration/$(INTEGRATOR_DIR)/Make.package

endif

# Check if we should make a Nonaka plot and add to cpp definitions
ifeq ($(USE_NONAKA_PLOT), TRUE)
  DEFINES += -DNONAKA_PLOT
endif

ifeq ($(USE_SIMPLIFIED_SDC), TRUE)
  F90EXE_sources += integrator_sdc.F90
else
  F90EXE_sources += integrator.F90
endif
F90EXE_sources += integrator_scaling.F90
f90EXE_sources += integration_data.f90


INCLUDE_LOCATIONS += $(MICROPHYSICS_HOME)/integration/utils
VPATH_LOCATIONS   += $(MICROPHYSICS_HOME)/integration/utils
EXTERN_CORE       += $(MICROPHYSICS_HOME)/integration/utils

include $(MICROPHYSICS_HOME)/integration/utils/Make.package
